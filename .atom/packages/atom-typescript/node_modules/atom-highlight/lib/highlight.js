"use strict";
const _ = require("underscore");
const compareVersions = require("compare-versions");
function escapeChar(match) {
    switch (match) {
        case '&': return '&amp;';
        case '"': return '&quot;';
        case "'": return '&#39;';
        case '<': return '&lt;';
        case '>': return '&gt;';
        case ' ': return '&nbsp;';
        default: return match;
    }
}
function escapeString(inp) {
    return inp.replace(/[&"'<>]/g, escapeChar);
}
function escapeStringNbsp(inp) {
    return inp.replace(/[&"'<> ]/g, escapeChar);
}
function pushScope(scopeStack, scope, html) {
    scopeStack.push(scope);
    html.push(`<span class="${scope.replace(/\.+/g, ' ')}">`);
}
function popScope(scopeStack, html) {
    scopeStack.pop();
    html.push('</span>');
}
function updateScopeStack(scopeStack, desiredScopes, html) {
    let excessScopes = scopeStack.length - desiredScopes.length;
    if (excessScopes > 0) {
        while (excessScopes--) {
            popScope(scopeStack, html);
        }
    }
    let lasti = 0;
    for (let i = scopeStack.length; i >= 0; --i) {
        if (_.isEqual(scopeStack.slice(0, i), desiredScopes.slice(0, i))) {
            lasti = i;
            break;
        }
        popScope(scopeStack, html);
    }
    for (let j = lasti; j < desiredScopes.length; ++j) {
        pushScope(scopeStack, desiredScopes[j], html);
    }
}
const defaultOptions = {
    nbsp: true,
    lineDivs: false,
    editorDiv: false,
    wrapCode: false,
    editorDivTag: 'div',
    editorDivClass: 'editor editor-colors',
    nullScope: 'text.plain.null-grammar',
};
module.exports = function highlightSync(options) {
    const registry = atom.grammars.textmateRegistry || atom.grammars;
    const o = Object.assign({}, defaultOptions, options);
    const grammar = registry.grammarForScopeName(o.scopeName) || (o.nullScope ? registry.grammarForScopeName(o.nullScope) : undefined);
    if (grammar === undefined) {
        throw new Error(`Grammar ${o.scopeName} not found, and no ${o.nullScope} grammar`);
    }
    const lineTokens = grammar.tokenizeLines(o.fileContents);
    if (lineTokens.length > 0) {
        const lastLineTokens = lineTokens[lineTokens.length - 1];
        if (lastLineTokens.length === 1 && lastLineTokens[0].value === '') {
            lineTokens.pop();
        }
    }
    const escape = o.nbsp ? escapeStringNbsp : escapeString;
    const html = [];
    if (o.editorDiv)
        html.push(`<${o.editorDivTag} class="${o.editorDivClass}">`);
    if (o.wrapCode)
        html.push('<code>');
    for (const tokens of lineTokens) {
        const scopeStack = [];
        if (o.lineDivs)
            html.push('<div class="line">');
        for (const { value, scopes } of tokens) {
            let newScopes = scopes;
            if (compareVersions(atom.getVersion(), '1.13.0') >= 0) {
                newScopes = scopes.map((s) => `syntax--${s.replace(/\./g, '.syntax--')}`);
            }
            updateScopeStack(scopeStack, newScopes, html);
            html.push(`<span>${escape(value)}</span>`);
        }
        while (scopeStack.length > 0) {
            popScope(scopeStack, html);
        }
        if (o.lineDivs)
            html.push('</div>');
        html.push('\n');
    }
    if (o.wrapCode)
        html.push('</code>');
    if (o.editorDiv)
        html.push(`</${o.editorDivTag}>`);
    return html.join('');
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaGlnaGxpZ2h0LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vc3JjL2hpZ2hsaWdodC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUEsZ0NBQWdDO0FBQ2hDLG9EQUFvRDtBQUdwRCxvQkFBb0IsS0FBYTtJQUMvQixNQUFNLENBQUMsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDO1FBQ2QsS0FBSyxHQUFHLEVBQUUsTUFBTSxDQUFDLE9BQU8sQ0FBQTtRQUN4QixLQUFLLEdBQUcsRUFBRSxNQUFNLENBQUMsUUFBUSxDQUFBO1FBQ3pCLEtBQUssR0FBRyxFQUFFLE1BQU0sQ0FBQyxPQUFPLENBQUE7UUFDeEIsS0FBSyxHQUFHLEVBQUUsTUFBTSxDQUFDLE1BQU0sQ0FBQTtRQUN2QixLQUFLLEdBQUcsRUFBRSxNQUFNLENBQUMsTUFBTSxDQUFBO1FBQ3ZCLEtBQUssR0FBRyxFQUFFLE1BQU0sQ0FBQyxRQUFRLENBQUE7UUFDekIsU0FBUyxNQUFNLENBQUMsS0FBSyxDQUFBO0lBQ3ZCLENBQUM7QUFDSCxDQUFDO0FBRUQsc0JBQXNCLEdBQVc7SUFDL0IsTUFBTSxDQUFDLEdBQUcsQ0FBQyxPQUFPLENBQUMsVUFBVSxFQUFFLFVBQVUsQ0FBQyxDQUFBO0FBQzVDLENBQUM7QUFFRCwwQkFBMEIsR0FBVztJQUNuQyxNQUFNLENBQUMsR0FBRyxDQUFDLE9BQU8sQ0FBQyxXQUFXLEVBQUUsVUFBVSxDQUFDLENBQUE7QUFDN0MsQ0FBQztBQUVELG1CQUFtQixVQUFvQixFQUFFLEtBQWEsRUFBRSxJQUFjO0lBQ3BFLFVBQVUsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUE7SUFDdEIsSUFBSSxDQUFDLElBQUksQ0FBQyxnQkFBZ0IsS0FBSyxDQUFDLE9BQU8sQ0FBQyxNQUFNLEVBQUUsR0FBRyxDQUFDLElBQUksQ0FBQyxDQUFBO0FBQzNELENBQUM7QUFFRCxrQkFBa0IsVUFBb0IsRUFBRSxJQUFjO0lBQ3BELFVBQVUsQ0FBQyxHQUFHLEVBQUUs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QUFJLENBQUMsQ0FBQTtZQUM3QyxJQUFJLENBQUMsSUFBSSxDQUFDLFNBQVMsTUFBTSxDQUFDLEtBQUssQ0FBQyxTQUFTLENBQUMsQ0FBQTtRQUM1QyxDQUFDO1FBQ0QsT0FBTyxVQUFVLENBQUMsTUFBTSxHQUFHLENBQUMsRUFBRSxDQUFDO1lBQzdCLFFBQVEsQ0FBQyxVQUFVLEVBQUUsSUFBSSxDQUFDLENBQUE7UUFDNUIsQ0FBQztRQUNELEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxRQUFRLENBQUM7WUFBQyxJQUFJLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxDQUFBO1FBQ25DLElBQUksQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUE7SUFDakIsQ0FBQztJQUNELEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxRQUFRLENBQUM7UUFBQyxJQUFJLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxDQUFBO0lBQ3BDLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxTQUFTLENBQUM7UUFBQyxJQUFJLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDLFlBQVksR0FBRyxDQUFDLENBQUE7SUFDbEQsTUFBTSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDLENBQUE7QUFDdEIsQ0FBQyxDQUFBIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IF8gPSByZXF1aXJlKCd1bmRlcnNjb3JlJylcbmltcG9ydCBjb21wYXJlVmVyc2lvbnMgPSByZXF1aXJlKCdjb21wYXJlLXZlcnNpb25zJylcbmltcG9ydCB7fSBmcm9tICdhdG9tJ1xuXG5mdW5jdGlvbiBlc2NhcGVDaGFyKG1hdGNoOiBzdHJpbmcpOiBzdHJpbmcge1xuICBzd2l0Y2ggKG1hdGNoKSB7XG4gICAgY2FzZSAnJic6IHJldHVybiAnJmFtcDsnXG4gICAgY2FzZSAnXCInOiByZXR1cm4gJyZxdW90OydcbiAgICBjYXNlIFwiJ1wiOiByZXR1cm4gJyYjMzk7J1xuICAgIGNhc2UgJzwnOiByZXR1cm4gJyZsdDsnXG4gICAgY2FzZSAnPic6IHJldHVybiAnJmd0OydcbiAgICBjYXNlICcgJzogcmV0dXJuICcmbmJzcDsnXG4gICAgZGVmYXVsdDogcmV0dXJuIG1hdGNoXG4gIH1cbn1cblxuZnVuY3Rpb24gZXNjYXBlU3RyaW5nKGlucDogc3RyaW5nKTogc3RyaW5nIHtcbiAgcmV0dXJuIGlucC5yZXBsYWNlKC9bJlwiJzw+XS9nLCBlc2NhcGVDaGFyKVxufVxuXG5mdW5jdGlvbiBlc2NhcGVTdHJpbmdOYnNwKGlucDogc3RyaW5nKTogc3RyaW5nIHtcbiAgcmV0dXJuIGlucC5yZXBsYWNlKC9bJlwiJzw+IF0vZywgZXNjYXBlQ2hhcilcbn1cblxuZnVuY3Rpb24gcHVzaFNjb3BlKHNjb3BlU3RhY2s6IHN0cmluZ1tdLCBzY29wZTogc3RyaW5nLCBodG1sOiBzdHJpbmdbXSk6IHZvaWQge1xuICBzY29wZVN0YWNrLnB1c2goc2NvcGUpXG4gIGh0bWwucHVzaChgPHNwYW4gY2xhc3M9XCIke3Njb3BlLnJlcGxhY2UoL1xcLisvZywgJyAnKX1cIj5gKVxufVxuXG5mdW5jdGlvbiBwb3BTY29wZShzY29wZVN0YWNrOiBzdHJpbmdbXSwgaHRtbDogc3RyaW5nW10pOiB2b2lkIHtcbiAgc2NvcGVTdGFjay5wb3AoKVxuICBodG1sLnB1c2goJzwvc3Bhbj4nKVxufVxuXG5mdW5jdGlvbiB1cGRhdGVTY29wZVN0YWNrKHNjb3BlU3RhY2s6IHN0cmluZ1tdLCBkZXNpcmVkU2NvcGVzOiBzdHJpbmdbXSwgaHRtbDogc3RyaW5nW10pOiB2b2lkIHtcbiAgbGV0IGV4Y2Vzc1Njb3BlcyA9IHNjb3BlU3RhY2subGVuZ3RoIC0gZGVzaXJlZFNjb3Blcy5sZW5ndGhcbiAgaWYgKGV4Y2Vzc1Njb3BlcyA+IDApIHtcbiAgICB3aGlsZSAoZXhjZXNzU2NvcGVzLS0pIHtcbiAgICAgIHBvcFNjb3BlKHNjb3BlU3RhY2ssIGh0bWwpXG4gICAgfVxuICB9XG5cbiAgLy8gcG9wIHVudGlsIGNvbW1vbiBwcmVmaXhcbiAgbGV0IGxhc3RpID0gMFxuICBmb3IgKGxldCBpID0gc2NvcGVTdGFjay5sZW5ndGg7IGkgPj0gMDsgLS1pKSB7XG4gICAgaWYgKF8uaXNFcXVhbChzY29wZVN0YWNrLnNsaWNlKDAsIGkpLCBkZXNpcmVkU2NvcGVzLnNsaWNlKDAsIGkpKSkge1xuICAgICAgbGFzdGkgPSBpXG4gICAgICBicmVha1xuICAgIH1cbiAgICBwb3BTY29wZShzY29wZVN0YWNrLCBodG1sKVxuICB9XG4gIC8vIHB1c2ggb24gdG9wIG9mIGNvbW1vbiBwcmVmaXggdW50aWwgc2NvcGVTdGFjayBpcyBkZXNpcmVkU2NvcGVzXG4gIGZvciAobGV0IGogPSBsYXN0aTsgaiA8IGRlc2lyZWRTY29wZXMubGVuZ3RoOyArK2opIHtcbiAgICBwdXNoU2NvcGUoc2NvcGVTdGFjaywgZGVzaXJlZFNjb3Blc1tqXSwgaHRtbClcbiAgfVxufVxuXG5jb25zdCBkZWZhdWx0T3B0aW9ucyA9IHtcbiAgbmJzcDogdHJ1ZSxcbiAgbGluZURpdnM6IGZhbHNlLFxuICBlZGl0b3JEaXY6IGZhbHNlLFxuICB3cmFwQ29kZTogZmFsc2UsXG4gIGVkaXRvckRpdlRhZzogJ2RpdicsXG4gIGVkaXRvckRpdkNsYXNzOiAnZWRpdG9yIGVkaXRvci1jb2xvcnMnLFxuICBudWxsU2NvcGU6ICd0ZXh0LnBsYWluLm51bGwtZ3JhbW1hcicsXG59XG5cbmV4cG9ydCA9IGZ1bmN0aW9uIGhpZ2hsaWdodFN5bmMoXG4gIG9wdGlvbnM6IHtcbiAgICBmaWxlQ29udGVudHM6IHN0cmluZ1xuICAgIHNjb3BlTmFtZTogc3RyaW5nXG4gIH0gJiBQYXJ0aWFsPHtcbiAgICBuYnNwOiBib29sZWFuXG4gICAgbGluZURpdnM6IGJvb2xlYW5cbiAgICBlZGl0b3JEaXY6IGJvb2xlYW5cbiAgICB3cmFwQ29kZTogYm9vbGVhblxuICAgIGVkaXRvckRpdlRhZzogc3RyaW5nXG4gICAgZWRpdG9yRGl2Q2xhc3M6IHN0cmluZ1xuICAgIG51bGxTY29wZTogc3RyaW5nXG4gIH0+LFxuKTogc3RyaW5nIHtcbiAgY29uc3QgcmVnaXN0cnkgPSBhdG9tLmdyYW1tYXJzLnRleHRtYXRlUmVnaXN0cnkgfHwgYXRvbS5ncmFtbWFyc1xuICBjb25zdCBvID0gey4uLmRlZmF1bHRPcHRpb25zLCAuLi5vcHRpb25zfVxuXG4gIGNvbnN0IGdyYW1tYXIgPSByZWdpc3RyeS5ncmFtbWFyRm9yU2NvcGVOYW1lKG8uc2NvcGVOYW1lKSB8fCAoby5udWxsU2NvcGUgPyByZWdpc3RyeS5ncmFtbWFyRm9yU2NvcGVOYW1lKG8ubnVsbFNjb3BlKSA6IHVuZGVmaW5lZClcbiAgaWYgKGdyYW1tYXIgPT09IHVuZGVmaW5lZCkge1xuICAgIHRocm93IG5ldyBFcnJvcihgR3JhbW1hciAke28uc2NvcGVOYW1lfSBub3QgZm91bmQsIGFuZCBubyAke28ubnVsbFNjb3BlfSBncmFtbWFyYClcbiAgfVxuXG4gIGNvbnN0IGxpbmVUb2tlbnMgPSBncmFtbWFyLnRva2VuaXplTGluZXMoby5maWxlQ29udGVudHMpXG5cbiAgLy8gUmVtb3ZlIHRyYWlsaW5nIG5ld2xpbmVcbiAgaWYgKGxpbmVUb2tlbnMubGVuZ3RoID4gMCkge1xuICAgIGNvbnN0IGxhc3RMaW5lVG9rZW5zID0gbGluZVRva2Vuc1tsaW5lVG9rZW5zLmxlbmd0aCAtIDFdXG5cbiAgICBpZiAobGFzdExpbmVUb2tlbnMubGVuZ3RoID09PSAxICYmIGxhc3RMaW5lVG9rZW5zWzBdLnZhbHVlID09PSAnJykge1xuICAgICAgbGluZVRva2Vucy5wb3AoKVxuICAgIH1cbiAgfVxuXG4gIGNvbnN0IGVzY2FwZSA9IG8ubmJzcCA/IGVzY2FwZVN0cmluZ05ic3AgOiBlc2NhcGVTdHJpbmdcblxuICBjb25zdCBodG1sOiBzdHJpbmdbXSA9IFtdXG4gIGlmIChvLmVkaXRvckRpdikgaHRtbC5wdXNoKGA8JHtvLmVkaXRvckRpdlRhZ30gY2xhc3M9XCIke28uZWRpdG9yRGl2Q2xhc3N9XCI+YClcbiAgaWYgKG8ud3JhcENvZGUpIGh0bWwucHVzaCgnPGNvZGU+JylcbiAgZm9yIChjb25zdCB0b2tlbnMgb2YgbGluZVRva2Vucykge1xuICAgIGNvbnN0IHNjb3BlU3RhY2s6IHN0cmluZ1tdID0gW11cbiAgICBpZiAoby5saW5lRGl2cykgaHRtbC5wdXNoKCc8ZGl2IGNsYXNzPVwibGluZVwiPicpXG4gICAgZm9yIChjb25zdCB7dmFsdWUsIHNjb3Blc30gb2YgdG9rZW5zKSB7XG4gICAgICBsZXQgbmV3U2NvcGVzID0gc2NvcGVzXG4gICAgICBpZiAoY29tcGFyZVZlcnNpb25zKGF0b20uZ2V0VmVyc2lvbigpLCAnMS4xMy4wJykgPj0gMCkge1xuICAgICAgICBuZXdTY29wZXMgPSBzY29wZXMubWFwKChzOiBzdHJpbmcpID0+IGBzeW50YXgtLSR7cy5yZXBsYWNlKC9cXC4vZywgJy5zeW50YXgtLScpfWApXG4gICAgICB9XG4gICAgICB1cGRhdGVTY29wZVN0YWNrKHNjb3BlU3RhY2ssIG5ld1Njb3BlcywgaHRtbClcbiAgICAgIGh0bWwucHVzaChgPHNwYW4+JHtlc2NhcGUodmFsdWUpfTwvc3Bhbj5gKVxuICAgIH1cbiAgICB3aGlsZSAoc2NvcGVTdGFjay5sZW5ndGggPiAwKSB7XG4gICAgICBwb3BTY29wZShzY29wZVN0YWNrLCBodG1sKVxuICAgIH1cbiAgICBpZiAoby5saW5lRGl2cykgaHRtbC5wdXNoKCc8L2Rpdj4nKVxuICAgIGh0bWwucHVzaCgnXFxuJylcbiAgfVxuICBpZiAoby53cmFwQ29kZSkgaHRtbC5wdXNoKCc8L2NvZGU+JylcbiAgaWYgKG8uZWRpdG9yRGl2KSBodG1sLnB1c2goYDwvJHtvLmVkaXRvckRpdlRhZ30+YClcbiAgcmV0dXJuIGh0bWwuam9pbignJylcbn1cbiJdfQ==